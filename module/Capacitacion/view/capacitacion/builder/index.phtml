<div class="container-fluid py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 m-0">Builder: <?= $this->escapeHtml($cap['title'] ?? '') ?></h1>
    <a class="btn btn-outline-secondary" href="<?= $this->url('capacitacion-admin/cap', ['action' => 'index']) ?>">Volver</a>
  </div>

  <div class="row">
    <div class="col-lg-6 mb-3">
      <div class="card shadow-sm">
        <div class="card-header">CapacitaciÃ³n</div>
        <div class="card-body">
          <?php $capForm->prepare(); ?>
          <?= $this->form()->openTag($capForm->setAttribute('action', $this->url('capacitacion-admin/cap', ['action' => 'edit', 'id' => (int)$cap['id']]))) ?>
          <?= $this->formHidden($capForm->get('id')) ?>

          <div class="form-group">
            <label><?= $capForm->get('title')->getLabel() ?></label>
            <?= $this->formElement($capForm->get('title')) ?>
          </div>

          <div class="form-group">
            <label><?= $capForm->get('alias')->getLabel() ?></label>
            <?= $this->formElement($capForm->get('alias')) ?>
          </div>

          <div class="form-group">
            <label><?= $capForm->get('description')->getLabel() ?></label>
            <?= $this->formElement($capForm->get('description')) ?>
          </div>

          <div class="form-row">
            <div class="form-group col-md-3">
              <label><?= $capForm->get('media_type')->getLabel() ?></label>
              <?= $this->formSelect($capForm->get('media_type')) ?>
            </div>
            <div class="form-group col-md-9">
              <label><?= $capForm->get('media_url')->getLabel() ?></label>
              <?= $this->formElement($capForm->get('media_url')) ?>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-8">
              <label><?= $capForm->get('thumbnail')->getLabel() ?></label>
              <?= $this->formElement($capForm->get('thumbnail')) ?>
            </div>
            <div class="form-group col-md-4">
              <label><?= $capForm->get('expires_at')->getLabel() ?></label>
              <?= $this->formElement($capForm->get('expires_at')) ?>
            </div>
          </div>

          <div class="custom-control custom-switch mb-3">
            <?= $this->formElement($capForm->get('published')->setAttribute('id', 'cap_published')) ?>
            <label class="custom-control-label" for="cap_published">Publicado</label>
          </div>

          <?= $this->formSubmit($capForm->get('submit')) ?>
          <?= $this->form()->closeTag() ?>
        </div>
      </div>
    </div>

    <div class="col-lg-6 mb-3">
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Quiz Â· Tipo de premio</span>
          <span class="text-muted small">Awarded: <?= (int)($quiz['reward_awarded_count'] ?? 0) ?></span>
        </div>
        <div class="card-body">
          <?php $quizForm->prepare(); ?>
          <?= $this->form()->openTag($quizForm->setAttribute('action', $this->url('capacitacion-admin/quiz', ['action' => 'edit', 'id' => (int)$quiz['id']]))) ?>
          <?= $this->formHidden($quizForm->get('id')) ?>
          <?= $this->formHidden($quizForm->get('capacitacion_id')) ?>

          <div class="form-group">
            <label><?= $quizForm->get('title')->getLabel() ?></label>
            <?= $this->formElement($quizForm->get('title')) ?>
          </div>

          <div class="form-row">
            <div class="form-group col-md-4">
              <label><?= $quizForm->get('max_attempts')->getLabel() ?></label>
              <?= $this->formElement($quizForm->get('max_attempts')) ?>
            </div>
            <div class="form-group col-md-4">
              <label><?= $quizForm->get('pass_score')->getLabel() ?></label>
              <?= $this->formElement($quizForm->get('pass_score')) ?>
            </div>
            <div class="form-group col-md-4">
              <label><?= $quizForm->get('reward_limit')->getLabel() ?></label>
              <?= $this->formElement($quizForm->get('reward_limit')) ?>
            </div>
          </div>

          <div class="custom-control custom-switch mb-3">
            <?= $this->formElement($quizForm->get('published')->setAttribute('id', 'quiz_published')) ?>
            <label class="custom-control-label" for="quiz_published">Publicado</label>
          </div>

          <div class="form-group">
            <label><?= $quizForm->get('reward_mode')->getLabel() ?></label>
            <?= $this->formSelect($quizForm->get('reward_mode')->setAttribute('id', 'reward_mode')) ?>
          </div>

          <div class="form-group reward-points">
            <label><?= $quizForm->get('reward_points')->getLabel() ?></label>
            <?= $this->formElement($quizForm->get('reward_points')) ?>
            <small class="form-text text-muted">Solo nÃºmeros. Sin barritas molestas ðŸ˜…</small>
          </div>

          <div class="form-group reward-product">
            <label><?= $quizForm->get('reward_product_id')->getLabel() ?></label>
            <?= $this->formSelect($quizForm->get('reward_product_id')->setAttribute('id', 'reward_product_id')) ?>
            <small class="form-text text-muted">Productos: j6bp1_store_products.type = 'ereward'</small>
          </div>

          <?= $this->formSubmit($quizForm->get('submit')) ?>
          <?= $this->form()->closeTag() ?>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Preguntas</span>
      <button class="btn btn-sm btn-primary js-add-question" type="button" data-url="<?= $this->url('capacitacion-admin/question', ['action' => 'add']) ?>?ajax=1&quiz_id=<?= (int)$quiz['id'] ?>">
        <i class="fa fa-plus"></i> Agregar pregunta
      </button>
    </div>
    <div class="card-body">
      <?php if (empty($questions)): ?>
        <div class="alert alert-info mb-0">AÃºn no hay preguntas. Crea la primera ðŸš€</div>
      <?php else: ?>
        <div class="accordion" id="qAccordion">
          <?php foreach ($questions as $i => $q): $qid = (int)$q['id']; ?>
            <div class="js-qwrap" data-question-id="<?= $qid ?>">
              <?= $this->partial('capacitacion/partial/question-card', ['q' => $q, 'capId' => (int)$cap['id'], 'answers' => $answers]) ?>
            </div>
          <?php endforeach; ?>
        </div>
      <?php endif; ?>
    </div>
  </div>
</div>


<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Select2 (si tu layout ya lo trae, esto no estorba) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
(function($){
  if (!window.Swal || !$) return;
  function toast(msg){
    console.log(msg);
  }

  function bindFilePreview($root){
    if (!$root || !$root.length) return;

    $root.find('input[type="file"]').off('change.capfile').on('change.capfile', function(){
      var file = this.files && this.files[0];
      var $label = $(this).closest('.custom-file').find('.custom-file-label');
      if ($label.length) $label.text(file ? file.name : 'Selecciona archivoâ€¦');

      if (!file) return;

      // 2MB limit (ajÃºstalo si quieres)
      if (file.size > (2 * 1024 * 1024)) {
        alert('MÃ¡ximo 2MB');
        this.value = '';
        return;
      }

      var url = URL.createObjectURL(file);
      var $wrap = $(this).closest('.form-group').find('.js-file-preview');
      if ($wrap.length){
        $wrap.removeClass('d-none');
        $wrap.find('.js-file-preview-img').attr('src', url);
      }
    });
  }

  function syncRewardInline(){
    var v = $('#reward_mode').val() || 'none';
    $('.reward-points').toggle(v === 'points');
    // UI: ereward (aunque guardes como product en BD)
    $('.reward-product').toggle(v === 'ereward');
  }

  function syncRewardInModal($root){
    var $mode = $root.find('#reward_mode');
    if (!$mode.length) return;

    function run(){
      var v = $mode.val() || 'none';
      $root.find('.reward-points').toggle(v === 'points');
      $root.find('.reward-product').toggle(v === 'ereward');
    }

    $mode.off('change.capreward').on('change.capreward', run);
    run();
  }

  function enhanceModal($root){
    if ($.fn.select2){
      $root.find('.select2').select2({ width: '100%' });
    }
    bindFilePreview($root);
    syncRewardInModal($root);
  }

  function showModalFromUrl(url){
    Swal.fire({
      title: 'Cargando...',
      html: '<div class="text-muted">Espere...</div>',
      showConfirmButton: false,
      allowOutsideClick: false,
      didOpen: function(){
        Swal.showLoading();

        $.get(url)
          .done(function(html){
            Swal.fire({
              title: '',
              html: html,
              showConfirmButton: false,
              showCloseButton: true,
              width: 800,
              didOpen: function(){
                enhanceModal($(Swal.getHtmlContainer()));
              }
            });
          })
          .fail(function(){
            Swal.fire('Error', 'No pude cargar el formulario.', 'error');
          });
      }
    });
  }

  function replaceQuestionCard(questionId, html){
    var $wrap = $('.js-qwrap[data-question-id="' + questionId + '"]');
    if ($wrap.length) $wrap.html(html);
    else $('#qAccordion').prepend('<div class="js-qwrap" data-question-id="'+questionId+'">'+html+'</div>');
  }

  function refreshAnswers(questionId, html){
    $('.js-answers-wrap[data-question-id="' + questionId + '"]').html(html);
  }

  // DOM ready
  $(function(){

    if ($.fn.select2){
      $('#reward_product_id').select2({ width: '100%' });
    }

    $('#reward_mode').off('change.capreward').on('change.capreward', syncRewardInline);
    syncRewardInline();

    // Open modals
    $(document).on('click', '.js-add-question, .js-edit-question, .js-add-answer, .js-edit-answer', function(){
      showModalFromUrl($(this).data('url'));
    });

    // Submit modal forms via AJAX (supports file)
    $(document).on('submit', '.js-ajax-form', function(e){
      e.preventDefault();

      var $form = $(this);
      var action = $form.attr('action');
      var fd = new FormData(this);

      var $root = $(Swal.getHtmlContainer());
      var $err = $root.find('.js-modal-error');
      $err.addClass('d-none').text('');

      $.ajax({
        url: action,
        method: 'POST',
        data: fd,
        processData: false,
        contentType: false,
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        dataType: 'json'
      })
      .done(function(res){
        if (!res || !res.success){
          $err.removeClass('d-none').text(res && res.message ? res.message : 'Error');
          return;
        }

        if (res.questionCardHtml && res.questionId){
          replaceQuestionCard(res.questionId, res.questionCardHtml);
        }
        if (res.answersHtml && res.questionId){
          refreshAnswers(res.questionId, res.answersHtml);
        }

        Swal.close();
        toast('Guardado');
      })
      .fail(function(xhr){
        var msg = (xhr.responseJSON && xhr.responseJSON.message) ? xhr.responseJSON.message : ('HTTP ' + xhr.status);
        $err.removeClass('d-none').text('Error: ' + msg);
      });
    });

    // Delete question
    $(document).on('click', '.js-del-question', function(){
      if (!confirm('Â¿Eliminar pregunta?')) return;

      $.ajax({
        url: $(this).data('url'),
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        dataType: 'json',
        data: { ajax: 1 }
      })
      .done(function(res){
        if (res && res.success && res.questionId){
          $('.js-qwrap[data-question-id="' + res.questionId + '"]').remove();
        }
      });
    });

    // Delete answer
    $(document).on('click', '.js-del-answer', function(){
      if (!confirm('Â¿Eliminar respuesta?')) return;

      $.ajax({
        url: $(this).data('url'),
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        dataType: 'json',
        data: { ajax: 1 }
      })
      .done(function(res){
        if (res && res.success && res.questionId && res.answersHtml){
          refreshAnswers(res.questionId, res.answersHtml);
        }
      });
    });

  });

})(window.jQuery);
</script>