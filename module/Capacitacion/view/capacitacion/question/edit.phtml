<?php 
if($this->isAjax):
  echo json_encode($this->data);
  die();
endif;
?>
<div class="container-fluid py-3">
  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Editar pregunta #<?= (int)($row['id'] ?? 0) ?></span>
      <a class="btn btn-sm btn-outline-secondary" href="javascript:history.back()">Volver</a>
    </div>
    <div class="card-body">

      <?php if (!empty($row['image'])): ?>
        <div class="mb-3">
          <div class="text-muted small mb-1">Imagen actual</div>
          <img src="/<?= $this->escapeHtml($row['image']) ?>" style="max-width: 420px; border-radius: 10px;" class="img-fluid">
        </div>
      <?php endif; ?>

      <?php $form->prepare(); ?>
      <?= $this->form()->openTag($form) ?>
      <?= $this->formHidden($form->get('id')) ?>
      <?= $this->formHidden($form->get('quiz_id')) ?>

      <div class="form-group">
        <label><?= $form->get('question_text')->getLabel() ?></label>
        <?= $this->formElement($form->get('question_text')) ?>
      </div>

      <div class="form-row">
        <div class="form-group col-md-5">
          <label><?= $form->get('type')->getLabel() ?></label>
          <?= $this->formSelect($form->get('type')) ?>
        </div>
        <div class="form-group col-md-3">
          <label><?= $form->get('ordering')->getLabel() ?></label>
          <?= $this->formElement($form->get('ordering')) ?>
        </div>
        <div class="form-group col-md-4 d-flex align-items-end">
          <div class="custom-control custom-switch">
            <?= $this->formElement($form->get('published')->setAttribute('id','q_published')) ?>
            <label class="custom-control-label" for="q_published">Publicado</label>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label>Reemplazar imagen</label>
        <div class="custom-file">
          <?= $this->formElement($form->get('image')->setAttribute('id','q_image')) ?>
          <label class="custom-file-label" for="q_image">Selecciona una imagen…</label>
        </div>
        <small class="form-text text-muted">Si subes una nueva, la anterior se elimina automáticamente.</small>
      </div>

      <div class="mb-3" style="display:none;" id="previewWrap">
        <div class="text-muted small mb-1">Preview</div>
        <img id="imgPreview" style="max-width: 420px; border-radius: 10px;" class="img-fluid">
      </div>

      <?= $this->formSubmit($form->get('submit')) ?>
      <?= $this->form()->closeTag() ?>
    </div>
  </div>
</div>

<script>
(function(){
  function bytesToMb(b){ return (b/1024/1024).toFixed(2); }

  document.addEventListener('DOMContentLoaded', function(){
    var input = document.getElementById('q_image');
    if(!input) return;

    input.addEventListener('change', function(){
      var file = input.files && input.files[0];
      var label = input.closest('.custom-file').querySelector('.custom-file-label');
      if(label) label.textContent = file ? file.name : 'Selecciona una imagen…';

      if(!file) return;

      if(file.size > (2*1024*1024)){
        alert('La imagen pesa ' + bytesToMb(file.size) + 'MB. Máximo 2MB.');
        input.value = '';
        return;
      }

      var url = URL.createObjectURL(file);
      document.getElementById('imgPreview').src = url;
      document.getElementById('previewWrap').style.display = '';
    });
  });
})();
</script>
